{% extends "users/base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/cinema.css' %}">
<style>
.cinema-hero-video-container {
  position: relative;
  width: 100%;
  height: 400px;
  overflow: hidden;
  display: flex;
  align-items: center;
}
.cinema-hero-video-container video {
  position: absolute;
  width: 100%;
  height: 100%;
  object-fit: cover;
  left: 0;
  top: 0;
  z-index: 1;
}
.cinema-hero-text-block {
  position: relative;
  z-index: 2;
  margin-left: 3vw;
  margin-right: auto;
  background: rgba(24,24,24,0.65);
  border-radius: 18px;
  padding: 2rem 2.5rem 2rem 2.5rem;
  max-width: 420px;
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  justify-content: center;
}
.cinema-hero-text-block h1 {
  font-family: 'Montserrat', 'Roboto', Arial, sans-serif;
  font-size: 2.5rem;
  font-weight: 800;
  color: #fff;
  letter-spacing: 1px;
  margin-bottom: 1rem;
  background: none;
  -webkit-background-clip: initial;
  -webkit-text-fill-color: initial;
  text-shadow: none;
}
.cinema-hero-text-block p {
  font-size: 1.1rem;
  color: #e0e0e0;
  font-weight: 400;
  margin-bottom: 1.3rem;
  text-shadow: none;
  animation: fadeInUp 1.2s;
}
.cinema-hero-text-block a {
  display: inline-block;
  padding: 0.6rem 1.8rem;
  font-size: 1rem;
  font-weight: 600;
  color: #fff;
  background: #e50914;
  border: none;
  border-radius: 24px;
  box-shadow: 0 2px 8px #e5091444;
  text-decoration: none;
  transition: background 0.2s, transform 0.18s;
}
.cinema-hero-text-block a:hover {
  background: #b0060f;
  color: #fff;
}
@media (max-width: 900px) {
  .cinema-hero-video-container {
    height: 220px;
  }
  .cinema-hero-text-block {
    max-width: 98vw;
    margin: 0 auto;
    padding: 1.2rem 1rem;
    align-items: center;
  }
  .cinema-hero-text-block h1 {
    font-size: 1.5rem;
  }
}
</style>
{% endblock %}

{% block content %}
<div class="cinema-hero-video-container">
  <video autoplay loop muted playsinline>
    <source src="{% static 'video/video_for_interface.mp4' %}" type="video/mp4">
    Your browser does not support the video tag.
  </video>
  <div class="cinema-hero-text-block">
    <h1>Culturo Cinema</h1>
    <p>Discover, share, and experience cinema differently: recommendations, events, and local discoveries.</p>
    <a href="#now-showing">Explore Now</a>
  </div>
</div>

<div class="container">
    <!-- Quick Navigation -->
    <nav class="cinema-quicknav">
        <a href="#news" class="quicknav-item">
            <img src="https://images.unsplash.com/photo-1517602302552-471fe67acf66?auto=format&fit=crop&w=100&q=80"
                alt="Now Showing">
            <span>Latest Releases</span>
        </a>
        <a href="#agenda" class="quicknav-item">
            <img src="https://images.unsplash.com/photo-1504384308090-c894fdcc538d?auto=format&fit=crop&w=100&q=80"
                alt="Agenda">
            <span>Agenda</span>
        </a>
        <a href="#recommandations" class="quicknav-item">
            <img src="https://images.unsplash.com/photo-1465101046530-73398c7f28ca?auto=format&fit=crop&w=100&q=80"
                alt="News">
            <span>Recommendations</span>
        </a>
        
    </nav>

    <section class="cinema-section" id="news">
        <!-- Nouvelles cartes pour les dernières sorties cinéma --> 
            <h2 class="section-title" style="margin-bottom: 2rem;">Latest Releases</h2> 
            <div style="display: flex; flex-wrap: wrap; gap: 2rem; justify-content: center;"> 
                <!-- Card 1 --> 
                <div style="flex: 1 1 300px; max-width: 350px; background: #1a1a1a; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.2); transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-8px)'" onmouseout="this.style.transform='translateY(0)'"> 
                    <div style="position: relative; height: 250px; overflow: hidden;"> 
                        <img src="https://images.unsplash.com/photo-1536440136628-849c177e76a1?auto=format&fit=crop&w=500&q=80" alt="Film Poster" style="width: 100%; height: 100%; object-fit: cover;"> 
                        <div style="position: absolute; top: 10px; right: 10px; background: #e50914; color: white; padding: 5px 10px; border-radius: 4px; font-weight: 600; font-size: 0.9rem;">NEW</div> 
                    </div> 
                    <div style="padding: 1.5rem;"> 
                        <h3 style="font-size: 1.4rem; margin-bottom: 0.5rem; color: white;">Dune: Part Two</h3> 
                        <div style="display: flex; align-items: center; margin-bottom: 1rem;"> 
                            <span style="color: #e50914; margin-right: 0.5rem;">★★★★</span> 
                            <span style="color: #999; font-size: 0.9rem;">4.5/5</span> 
                        </div> 
                        <p style="color: #ccc; margin-bottom: 1.5rem; font-size: 0.95rem;">The epic sequel to Frank Herbert's adaptation by Denis Villeneuve.</p> 
                    </div> 
                </div> 
                
                <!-- Card 2 --> 
                <div style="flex: 1 1 300px; max-width: 350px; background: #1a1a1a; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.2); transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-8px)'" onmouseout="this.style.transform='translateY(0)'"> 
                    <div style="position: relative; height: 250px; overflow: hidden;"> 
                        <img src="https://images.unsplash.com/photo-1509347528160-9a9e33742cdb?w=900&auto=format&fit=crop&q=60&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTB8fGJhdG1hbnxlbnwwfHwwfHx8MA%3D%3D" alt="Film Poster" style="width: 100%; height: 100%; object-fit: cover;"> 
                        <div style="position: absolute; top: 10px; right: 10px; background: #e50914; color: white; padding: 5px 10px; border-radius: 4px; font-weight: 600; font-size: 0.9rem;">NEW</div> 
                    </div> 
                    <div style="padding: 1.5rem;"> 
                        <h3 style="font-size: 1.4rem; margin-bottom: 0.5rem; color: white;">The Batman</h3> 
                        <div style="display: flex; align-items: center; margin-bottom: 1rem;"> 
                            <span style="color: #e50914; margin-right: 0.5rem;">★★★★</span> 
                            <span style="color: #999; font-size: 0.9rem;">4.2/5</span> 
                        </div> 
                        <p style="color: #ccc; margin-bottom: 1.5rem; font-size: 0.95rem;">A dark and captivating take on Gotham's vigilante by Matt Reeves.</p> 
                    </div> 
                </div> 
                            <!-- Carte 3 --> 
            <div style="flex: 1 1 300px; max-width: 350px; background: #1a1a1a; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.2); transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-8px)'" onmouseout="this.style.transform='translateY(0)'"> 
            <div style="position: relative; height: 250px; overflow: hidden;"> 
                <img src="https://images.unsplash.com/photo-1594909122845-11baa439b7bf?auto=format&fit=crop&w=500&q=80" alt="Film Poster" style="width: 100%; height: 100%; object-fit: cover;"> 
                <div style="position: absolute; top: 10px; right: 10px; background: #e50914; color: white; padding: 5px 10px; border-radius: 4px; font-weight: 600; font-size: 0.9rem;">NEW</div> 
            </div> 
            <div style="padding: 1.5rem;"> 
                <h3 style="font-size: 1.4rem; margin-bottom: 0.5rem; color: white;">Oppenheimer</h3> 
                <div style="display: flex; align-items: center; margin-bottom: 1rem;"> 
                    <span style="color: #e50914; margin-right: 0.5rem;">★★★★★</span> 
                    <span style="color: #999; font-size: 0.9rem;">4.8/5</span> 
                </div> 
                <p style="color: #ccc; margin-bottom: 1.5rem; font-size: 0.95rem;">Christopher Nolan's captivating biopic about the father of the atomic bomb.</p> 
            </div> 
        </div>

            </div>

            


        </div>
    </section>

    <!-- Agenda Section -->
    <section class="cinema-section" id="agenda">
        <div style="display: flex; flex-direction: column; gap: 1.5rem;">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <h2 class="section-title" style="margin-bottom: 0;">Agenda</h2>
                <a href="#" class="btn btn-secondary" style="margin-top: 0;margin-right:30px;">All Events</a>
            </div>
            <div style="display: flex; gap: 2rem; flex-wrap: wrap;">
                <div class="cinema-agenda-item" style="flex: 1 1 260px; min-width: 220px;">
                    <span class="cinema-agenda-date">Saturday, May 18, 2025</span>
                    <h4>Screening &amp; Debate: "Cinema and Society"</h4>
                    <p>Join us for an evening of discussion on social cinema, followed by a debate with passionate
                        speakers.</p>
                </div>
                <div class="cinema-agenda-item" style="flex: 1 1 260px; min-width: 220px;">
                    <span class="cinema-agenda-date">Sunday, May 25, 2025</span>
                    <h4>Outdoor Movie Night</h4>
                    <p>Enjoy a movie under the stars in your local park. Bring your friends and family!</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Now Showing Section -->
    <section class="cinema-section" id="recommandations">
        <h2 class="section-title">My Recommendations</h2>
        <div class="cinema-movies-grid"></div>
        <!-- Debug: Display raw data -->
        <div id="debug-recommendations" style="display:none; color: white; background: #1a1a1a; padding: 10px; margin: 10px 0; border-radius: 5px;">
            <h4>Raw recommendation data:</h4>
            <pre>{{ recommendations|safe }}</pre>
        </div>
        
        {{ recommendations|json_script:"initial-recommendations" }}
        
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                console.log('=== DEBUG: Starting recommendation loading ===');
                var initialElement = document.getElementById('initial-recommendations');
                if (!initialElement) {
                    console.error('❌ ERROR: Element with ID "initial-recommendations" not found');
                    return;
                }
                
                console.log('✅ Raw JSON script data:', initialElement.textContent);
                
                var recommendations = [];
                try {
                    recommendations = JSON.parse(initialElement.textContent);
                    console.log('✅ Data parsed successfully:', recommendations);
                    
                    // Display detailed information for each movie
                    if (recommendations && Array.isArray(recommendations)) {
                        console.log(`📊 Number of recommendations: ${recommendations.length}`);
                        recommendations.forEach((film, index) => {
                            console.log(`\n🎬 Movie #${index + 1}:`);
                            console.log(`   Name: ${film.name || 'Not specified'}`);
                            console.log(`   ID: ${film.entity_id || 'Not specified'}`);
                            console.log('   Image properties:', {
                                'film.image': film.image,
                                'film.image_url': film.image_url,
                                'film.properties.image': film.properties?.image,
                                'film.properties.poster_path': film.properties?.poster_path
                            });
                        });
                    } else {
                        console.warn('⚠️ Recommendations is not an array:', recommendations);
                    }
                } catch (e) {
                    console.error('❌ ERROR parsing recommendations:', e);
                    console.error('Raw recommendation content:', initialElement.textContent);
                    return;
                }
                
                if (recommendations && Array.isArray(recommendations)) {
                    console.log('Calling updateNowShowing with', recommendations.length, 'recommendations');
                    updateNowShowing(recommendations);
                } else {
                    console.error('Recommendations is not an array or is empty:', recommendations);
                    // Display error message to user
                    const grid = document.querySelector('.cinema-movies-grid');
                    if (grid) {
                        grid.innerHTML = '<div class="error-message">Unable to load recommendations. Please try again later.</div>';
                    }
                }
            });
        </script>
    </section>


    <!-- Dynamic Recommendations Section -->
    <section class="cinema-section" id="cinema-recommendations-section" style="display:none;">
        <h2 class="section-title">🎬 Your Movie Recommendations</h2>
        <div id="cinema-recommendations-loading"
            style="display:none;justify-content:center;align-items:center;height:60px;">
            <div class="spinner"
                style="width:38px;height:38px;border:4px solid #b61b23;border-top:4px solid #fff;border-radius:50%;animation:spin 1s linear infinite;">
            </div>
        </div>
        <ul id="cinema-recommendations" style="font-size:1.1rem; margin-top:1rem;"></ul>
        <div id="cinema-qloo-link" style="margin-top:1.5rem;"></div>
    </section>
</div>

<!-- Floating Chatbot Icon and Chat Window -->
<button id="chatbot-toggle" aria-label="Open Chatbot"
    style="position: fixed; bottom: 32px; right: 32px; z-index: 9999; background: #b61b23; color: #fff; border: none; border-radius: 50%; width: 60px; height: 60px; box-shadow: 0 4px 16px rgba(40,40,80,0.13); display: flex; align-items: center; justify-content: center; font-size: 2rem; cursor: pointer;">
    <i class="fas fa-comments"></i>
</button>

<!-- Chatbot Styles -->
<style>
    .chatbot-container {
        background: #fff;
        color: #212529;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    #chatbot-input {
        background: #fff;
        border: 1px solid #dee2e6;
        border-radius: 20px;
        padding: 0.8rem 1.2rem;
        color: #212529 !important;
        font-size: 1rem;
        caret-color: #b61b23;
    }
    #chatbot-input::placeholder {
        color: #6c757d !important;
    }
    .chat-message {
        color: #212529 !important;
    }
    .chatbot-header {
        background: #b61b23;
        color: #fff;
    }
    .chat-message.user {
        background: #f8f9fa;
        color: #212529;
    }
    .chat-message.bot {
        background: #b61b23;
        color: #fff;
    }
</style>

<!-- SUPPRIMEZ COMPLÈTEMENT ce premier chatbot (lignes 325-350 environ) -->
<!-- <div class="chatbot-container" style="position: fixed; bottom: 100px; right: 32px; z-index: 9998; width: 340px; max-width: 90vw; height: 420px; display: none; border-radius: 18px; box-shadow: 0 8px 32px rgba(40,40,80,0.18); overflow: hidden; display: flex; flex-direction: column;">
    <div
        style="background: #b61b23; color: #fff; padding: 1rem; font-weight: 700; display: flex; align-items: center; justify-content: space-between;">
        <span><i class="fas fa-robot"></i> Culturo Chatbot</span>
        <button id="chatbot-close" aria-label="Close Chatbot"
            style="background: none; border: none; color: #fff; font-size: 1.2rem; cursor: pointer;">&times;</button>
    </div>
    <div id="chatbot-messages"
        style="flex: 1 1 auto; padding: 1rem; background: #f8f9fa; overflow-y: auto; font-size: 1rem; display: flex; flex-direction: column; gap: 0.7rem;">
        <div class="chat-message bot"
            style="align-self: flex-start; background: #b61b23; color: #fff; border-radius: 12px; padding: 0.7rem 1rem; box-shadow: 0 2px 8px rgba(40,40,80,0.07); max-width: 85%;">
            Hello! How can I help you with cinema recommendations or events?
        </div>
    </div>
    <form id="chatbot-form"
        style="display: flex; align-items: center; padding: 0.7rem 1rem; background: #fff; border-top: 1px solid #eee;">
        <input id="chatbot-input" type="text" placeholder="Type your message..." autocomplete="off"
            style="flex: 1 1 auto; border: 1px solid #dee2e6; background: #fff; border-radius: 20px; padding: 0.6rem 1rem; font-size: 1rem; margin-right: 0.7rem; outline: none; color: #212529;">
        <button id="chatbot-send" type="submit"
            style="background: #b61b23; color: #fff; border: none; border-radius: 50%; width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer;"><i
                class="fas fa-paper-plane"></i></button>
    </form>
</div>

<!-- GARDEZ SEULEMENT ce chatbot -->
<div id="cinema-chatbot"
    style="display: none; position: fixed; bottom: 100px; right: 32px; width: 340px; max-width: 90vw; background: #fff; border-radius: 18px; box-shadow: 0 8px 32px rgba(40,40,80,0.18); z-index: 10000; overflow: hidden; display: flex; flex-direction: column; height: 420px;">
    <div
        style="background: #b61b23; color: #fff; padding: 1rem; font-weight: 700; display: flex; align-items: center; justify-content: space-between;">
        <span><i class="fas fa-robot"></i> Culturo Chatbot</span>
        <button id="chatbot-close" aria-label="Close Chatbot"
            style="background: none; border: none; color: #fff; font-size: 1.2rem; cursor: pointer;">&times;</button>
    </div>
    <div id="chatbot-messages"
        style="flex: 1 1 auto; padding: 1rem; background: #f8f9fa; overflow-y: auto; font-size: 1rem; color: #333; display: flex; flex-direction: column; gap: 0.7rem;">
        <div
            style="align-self: flex-start; background: black; border-radius: 12px; padding: 0.7rem 1rem; box-shadow: 0 2px 8px rgba(40,40,80,0.07); max-width: 85%;">
            Hello! How can I help you with cinema recommendations or events?</div>
    </div>
    <form id="chatbot-form"
        style="display: flex; align-items: center; padding: 0.7rem 1rem; background: #fff; border-top: 1px solid #eee;">
        <input id="chatbot-input" type="text" placeholder="Type your message..." autocomplete="off"
            style="flex: 1 1 auto; border: none; background: #f8f9fa; border-radius: 20px; padding: 0.6rem 1rem; font-size: 1rem; margin-right: 0.7rem; outline: none;">
        <button id="chatbot-send" type="submit"
            style="background: #b61b23; color: #fff; border: none; border-radius: 50%; width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer;"><i
                class="fas fa-paper-plane"></i></button>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/culturo.js' %}"></script>
<script>
    console.log('JS chatbot loaded');
    document.addEventListener('DOMContentLoaded', function () {
        var toggle = document.getElementById('chatbot-toggle');
        var chatbot = document.getElementById('cinema-chatbot');
        var closeBtn = document.getElementById('chatbot-close');
        if (toggle && chatbot) {
            toggle.addEventListener('click', function () {
                chatbot.style.display = chatbot.style.display === 'none' ? 'flex' : 'none';
            });
        }
        if (closeBtn && chatbot) {
            closeBtn.addEventListener('click', function () {
                chatbot.style.display = 'none';
            });
        }

        // --- Dynamic cinema recommendations display ---
        // Assumes chatbot JS sends requests to /cinema_chatbot_api and receives JSON response
        // Intercepts chatbot form submission to handle display
        var chatbotForm = document.getElementById('chatbot-form');
        var chatbotInput = document.getElementById('chatbot-input');
        var chatbotMessages = document.getElementById('chatbot-messages');
        var recSection = document.getElementById('cinema-recommendations-section');
        var recList = document.getElementById('cinema-recommendations');
        var recLoading = document.getElementById('cinema-recommendations-loading');
        var chatHistory = [];
        if (chatbotForm && chatbotInput && chatbotMessages) {
            chatbotForm.addEventListener('submit', async function (e) {
                e.preventDefault();
                var userMsg = chatbotInput.value.trim();
                if (!userMsg) return;
                // Display user message
                var userDiv = document.createElement('div');
                userDiv.style.alignSelf = 'flex-end';
                userDiv.style.background = '#ffecd2';
                userDiv.style.borderRadius = '12px';
                userDiv.style.padding = '0.7rem 1rem';
                userDiv.style.margin = '0.2rem 0';
                userDiv.style.maxWidth = '85%';
                userDiv.textContent = userMsg;
                chatbotMessages.appendChild(userDiv);
                chatbotInput.value = '';
                chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
                // Add to chatHistory
                chatHistory.push({ role: 'user', content: userMsg });
                // Show loading spinner
                if (recLoading) recLoading.style.display = 'flex';
                // API call
                var response = await fetch('/cinema_chatbot_api/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ history: chatHistory })
                });
                var data = await response.json();
                console.log('Backend response:', data);
                // Hide loading spinner
                if (recLoading) recLoading.style.display = 'none';
                // Display bot response
                console.log('INLINE TEMPLATE SCRIPT - BOT MESSAGE:', data.message);
                var botDiv = document.createElement('div');
                botDiv.style.alignSelf = 'flex-start';
                var message = data.message;
                var trimmed = message && message.trim();
                if (trimmed && ((trimmed.startsWith('{') && trimmed.endsWith('}')) || /\{[\s\S]*?\}/.test(trimmed))) {
                  // Don't display anything
                } else {
                  botDiv.textContent = message;
                  botDiv.style.borderRadius = '12px';
                  botDiv.style.padding = '0.7rem 1rem';
                  botDiv.style.margin = '0.2rem 0';
                  botDiv.style.maxWidth = '85%';
                  chatbotMessages.appendChild(botDiv);
                }
                chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
                // Add to chatHistory
                chatHistory.push({ role: 'model', content: data.message });
                // If recommendations present and done=true, redirect to results page
                if (data.recommendations && data.recommendations.length && data.done) {
                    console.log('Redirecting to results page');
                    // window.location.href = '/cinema_recommendations_result/';
                }
            });
        }
    });
</script>
<style>
    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }
    @keyframes fadeInUp {
  from { opacity: 0; transform: translateY(40px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>
{% endblock %}