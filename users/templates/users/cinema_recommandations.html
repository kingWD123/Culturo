{% extends "users/base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/cinema.css' %}">
<style>
.cinema-hero-video-container {
  position: relative;
  width: 100%;
  height: 400px;
  overflow: hidden;
  display: flex;
  align-items: center;
}
.cinema-hero-video-container video {
  position: absolute;
  width: 100%;
  height: 100%;
  object-fit: cover;
  left: 0;
  top: 0;
  z-index: 1;
}
.cinema-hero-text-block {
  position: relative;
  z-index: 2;
  margin-left: 3vw;
  margin-right: auto;
  background: rgba(24,24,24,0.65);
  border-radius: 18px;
  padding: 2rem 2.5rem 2rem 2.5rem;
  max-width: 420px;
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  justify-content: center;
}
.cinema-hero-text-block h1 {
  font-family: 'Montserrat', 'Roboto', Arial, sans-serif;
  font-size: 2.5rem;
  font-weight: 800;
  color: #fff;
  letter-spacing: 1px;
  margin-bottom: 1rem;
  background: none;
  -webkit-background-clip: initial;
  -webkit-text-fill-color: initial;
  text-shadow: none;
}
.cinema-hero-text-block p {
  font-size: 1.1rem;
  color: #e0e0e0;
  font-weight: 400;
  margin-bottom: 1.3rem;
  text-shadow: none;
  animation: fadeInUp 1.2s;
}
.cinema-hero-text-block a {
  display: inline-block;
  padding: 0.6rem 1.8rem;
  font-size: 1rem;
  font-weight: 600;
  color: #fff;
  background: #e50914;
  border: none;
  border-radius: 24px;
  box-shadow: 0 2px 8px #e5091444;
  text-decoration: none;
  transition: background 0.2s, transform 0.18s;
}
.cinema-hero-text-block a:hover {
  background: #b0060f;
  color: #fff;
}
@media (max-width: 900px) {
  .cinema-hero-video-container {
    height: 220px;
  }
  .cinema-hero-text-block {
    max-width: 98vw;
    margin: 0 auto;
    padding: 1.2rem 1rem;
    align-items: center;
  }
  .cinema-hero-text-block h1 {
    font-size: 1.5rem;
  }
}
</style>
{% endblock %}

{% block content %}
<div class="cinema-hero-video-container">
  <video autoplay loop muted playsinline>
    <source src="{% static 'video/video_for_interface.mp4' %}" type="video/mp4">
    Your browser does not support the video tag.
  </video>
  <div class="cinema-hero-text-block">
    <h1>Culturo Cinema</h1>
    <p>Discover, share, and experience cinema differently: recommendations, events, and local discoveries.</p>
    <a href="#now-showing">Explore Now</a>
  </div>
</div>

<div class="container">
    <!-- Quick Navigation -->
    <nav class="cinema-quicknav">
        <a href="#now-showing" class="quicknav-item">
            <img src="https://images.unsplash.com/photo-1517602302552-471fe67acf66?auto=format&fit=crop&w=100&q=80"
                alt="Now Showing">
            <span>Now Showing</span>
        </a>
        <a href="#agenda" class="quicknav-item">
            <img src="https://images.unsplash.com/photo-1504384308090-c894fdcc538d?auto=format&fit=crop&w=100&q=80"
                alt="Agenda">
            <span>Agenda</span>
        </a>
        <a href="#news" class="quicknav-item">
            <img src="https://images.unsplash.com/photo-1465101046530-73398c7f28ca?auto=format&fit=crop&w=100&q=80"
                alt="News">
            <span>News</span>
        </a>
        <a href="#nearby" class="quicknav-item">
            <img src="https://images.unsplash.com/photo-1468071174046-657d9d351a40?auto=format&fit=crop&w=100&q=80"
                alt="Nearby Cinemas">
            <span>Nearby Cinemas</span>
        </a>
    </nav>

    <!-- Cinema News Section -->
    <section class="cinema-section" id="news">
        <div style="display: flex; flex-wrap: wrap; gap: 2.5rem; align-items: flex-start;">
            <div style="flex: 2 1 340px; min-width: 320px;">
                <h2 class="section-title" style="margin-bottom: 1rem;">Cinema News</h2>
                <article class="cinema-news-item">
                    <img src="https://images.unsplash.com/photo-1519125323398-675f0ddb6308?auto=format&fit=crop&w=400&q=80"
                        alt="Cinema news" class="cinema-news-img">
                    <div class="cinema-news-content">
                        <span class="cinema-news-date">Published May 5, 2025</span>
                        <h3>European Film Festival: Our Top Picks</h3>
                        <p>Discover Culturo's selection of must-see films at this year's festival.</p>
                        <a href="#" class="btn btn-primary">Read more</a>
                    </div>
                </article>
            </div>
            <div style="flex: 1 1 260px; min-width: 260px;">
                <h3 style="font-size: 1.2rem; font-weight: 700; margin-bottom: 1rem; color: #1a1a1a;">Latest News</h3>
                <ul class="cinema-news-list">
                    <li>
                        <span class="cinema-news-date">May 3, 2025</span><br>
                        <span style="font-weight: 600;">Cinema Night: Debate &amp; Screening</span><br>
                        <a href="#" style="color: #ff6b35; font-size: 0.98rem; text-decoration: underline;">Read
                            more</a>
                    </li>
                    <li>
                        <span class="cinema-news-date">April 24, 2025</span><br>
                        <span style="font-weight: 600;">New Local Cinema Opens</span><br>
                        <a href="#" style="color: #ff6b35; font-size: 0.98rem; text-decoration: underline;">Read
                            more</a>
                    </li>
                </ul>
            </div>
        </div>
    </section>

    <!-- Agenda Section -->
    <section class="cinema-section" id="agenda">
        <div style="display: flex; flex-direction: column; gap: 1.5rem;">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <h2 class="section-title" style="margin-bottom: 0;">Agenda</h2>
                <a href="#" class="btn btn-secondary" style="margin-top: 0;margin-right:30px;">All Events</a>
            </div>
            <div style="display: flex; gap: 2rem; flex-wrap: wrap;">
                <div class="cinema-agenda-item" style="flex: 1 1 260px; min-width: 220px;">
                    <span class="cinema-agenda-date">Saturday, May 18, 2025</span>
                    <h4>Screening &amp; Debate: "Cinema and Society"</h4>
                    <p>Join us for an evening of discussion on social cinema, followed by a debate with passionate
                        speakers.</p>
                </div>
                <div class="cinema-agenda-item" style="flex: 1 1 260px; min-width: 220px;">
                    <span class="cinema-agenda-date">Sunday, May 25, 2025</span>
                    <h4>Outdoor Movie Night</h4>
                    <p>Enjoy a movie under the stars in your local park. Bring your friends and family!</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Now Showing Section -->
    <section class="cinema-section" id="now-showing">
        <h2 class="section-title">Now Showing</h2>
        <div class="cinema-movies-grid"></div>
        <!-- Debug: Afficher les donn√©es brutes -->
        <div id="debug-recommendations" style="display:none; color: white; background: #1a1a1a; padding: 10px; margin: 10px 0; border-radius: 5px;">
            <h4>Donn√©es brutes des recommandations:</h4>
            <pre>{{ recommendations|safe }}</pre>
        </div>
        
        {{ recommendations|json_script:"initial-recommendations" }}
        
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                console.log('=== DEBUG: D√©but du chargement des recommandations ===');
                var initialElement = document.getElementById('initial-recommendations');
                if (!initialElement) {
                    console.error('‚ùå ERREUR: √âl√©ment avec l\'ID "initial-recommendations" introuvable');
                    return;
                }
                
                console.log('‚úÖ Donn√©es brutes du script JSON:', initialElement.textContent);
                
                var recommendations = [];
                try {
                    recommendations = JSON.parse(initialElement.textContent);
                    console.log('‚úÖ Donn√©es pars√©es avec succ√®s:', recommendations);
                    
                    // Afficher des informations d√©taill√©es sur chaque film
                    if (recommendations && Array.isArray(recommendations)) {
                        console.log(`üìä Nombre de recommandations: ${recommendations.length}`);
                        recommendations.forEach((film, index) => {
                            console.log(`\nüé¨ Film #${index + 1}:`);
                            console.log(`   Nom: ${film.name || 'Non sp√©cifi√©'}`);
                            console.log(`   ID: ${film.entity_id || 'Non sp√©cifi√©'}`);
                            console.log('   Propri√©t√©s image:', {
                                'film.image': film.image,
                                'film.image_url': film.image_url,
                                'film.properties.image': film.properties?.image,
                                'film.properties.poster_path': film.properties?.poster_path
                            });
                        });
                    } else {
                        console.warn('‚ö†Ô∏è Les recommandations ne sont pas un tableau:', recommendations);
                    }
                } catch (e) {
                    console.error('‚ùå ERREUR lors de l\'analyse des recommandations:', e);
                    console.error('Contenu brut des recommandations:', initialElement.textContent);
                    return;
                }
                
                if (recommendations && Array.isArray(recommendations)) {
                    console.log('Calling updateNowShowing with', recommendations.length, 'recommendations');
                    updateNowShowing(recommendations);
                } else {
                    console.error('Recommendations is not an array or is empty:', recommendations);
                    // Afficher un message d'erreur √† l'utilisateur
                    const grid = document.querySelector('.cinema-movies-grid');
                    if (grid) {
                        grid.innerHTML = '<div class="error-message">Unable to load recommendations. Please try again later.</div>';
                    }
                }
            });
        </script>
    </section>

    <!-- Nearby Cinemas Section -->
    <section class="cinema-section" id="nearby">
        <div class="cinema-local-info">
            <div class="cinema-local-text">
                <h2 class="section-title">Discover Cinemas Near You</h2>
                <p>Cinema is more than a venue: it's a place for encounters, discoveries, and sharing. Find programming,
                    events, and cultural initiatives in your region on Culturo.</p>
                <a href="#" class="btn btn-primary" style="margin-left:30px;">Learn more</a>
            </div>
            <div>
                <img src="https://images.unsplash.com/photo-1468071174046-657d9d351a40?auto=format&fit=crop&w=400&q=80"
                    alt="Local Cinema" class="cinema-local-img">
            </div>
        </div>
    </section>

    <!-- Dynamic Recommendations Section -->
    <section class="cinema-section" id="cinema-recommendations-section" style="display:none;">
        <h2 class="section-title">üé¨ Your Movie Recommendations</h2>
        <div id="cinema-recommendations-loading"
            style="display:none;justify-content:center;align-items:center;height:60px;">
            <div class="spinner"
                style="width:38px;height:38px;border:4px solid #ff6b35;border-top:4px solid #fff;border-radius:50%;animation:spin 1s linear infinite;">
            </div>
        </div>
        <ul id="cinema-recommendations" style="font-size:1.1rem; margin-top:1rem;"></ul>
        <div id="cinema-qloo-link" style="margin-top:1.5rem;"></div>
    </section>
</div>

<!-- Floating Chatbot Icon and Chat Window -->
<button id="chatbot-toggle" aria-label="Open Chatbot"
    style="position: fixed; bottom: 32px; right: 32px; z-index: 9999; background: #ff6b35; color: #fff; border: none; border-radius: 50%; width: 60px; height: 60px; box-shadow: 0 4px 16px rgba(40,40,80,0.13); display: flex; align-items: center; justify-content: center; font-size: 2rem; cursor: pointer;">
    <i class="fas fa-comments"></i>
</button>
<div id="cinema-chatbot"
    style="display: none; position: fixed; bottom: 100px; right: 32px; width: 340px; max-width: 90vw; background: #fff; border-radius: 18px; box-shadow: 0 8px 32px rgba(40,40,80,0.18); z-index: 10000; overflow: hidden; display: flex; flex-direction: column; height: 420px;">
    <div
        style="background: #ff6b35; color: #fff; padding: 1rem; font-weight: 700; display: flex; align-items: center; justify-content: space-between;">
        <span><i class="fas fa-robot"></i> Culturo Chatbot</span>
        <button id="chatbot-close" aria-label="Close Chatbot"
            style="background: none; border: none; color: #fff; font-size: 1.2rem; cursor: pointer;">&times;</button>
    </div>
    <div id="chatbot-messages"
        style="flex: 1 1 auto; padding: 1rem; background: #f8f9fa; overflow-y: auto; font-size: 1rem; color: #333; display: flex; flex-direction: column; gap: 0.7rem;">
        <div
            style="align-self: flex-start; background: black; border-radius: 12px; padding: 0.7rem 1rem; box-shadow: 0 2px 8px rgba(40,40,80,0.07); max-width: 85%;">
            Hello! How can I help you with cinema recommendations or events?</div>
    </div>
    <form id="chatbot-form"
        style="display: flex; align-items: center; padding: 0.7rem 1rem; background: #fff; border-top: 1px solid #eee;">
        <input id="chatbot-input" type="text" placeholder="Type your message..." autocomplete="off"
            style="flex: 1 1 auto; border: none; background: #f8f9fa; border-radius: 20px; padding: 0.6rem 1rem; font-size: 1rem; margin-right: 0.7rem; outline: none;">
        <button id="chatbot-send" type="submit"
            style="background: #ff6b35; color: #fff; border: none; border-radius: 50%; width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer;"><i
                class="fas fa-paper-plane"></i></button>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/culturo.js' %}"></script>
<script>
    console.log('JS chatbot charg√©');
    document.addEventListener('DOMContentLoaded', function () {
        var toggle = document.getElementById('chatbot-toggle');
        var chatbot = document.getElementById('cinema-chatbot');
        var closeBtn = document.getElementById('chatbot-close');
        if (toggle && chatbot) {
            toggle.addEventListener('click', function () {
                chatbot.style.display = chatbot.style.display === 'none' ? 'flex' : 'none';
            });
        }
        if (closeBtn && chatbot) {
            closeBtn.addEventListener('click', function () {
                chatbot.style.display = 'none';
            });
        }

        // --- Affichage dynamique des recommandations cin√©ma ---
        // On suppose que le chatbot JS envoie les requ√™tes √† /cinema_chatbot_api et re√ßoit la r√©ponse JSON
        // On intercepte la soumission du formulaire du chatbot pour g√©rer l'affichage
        var chatbotForm = document.getElementById('chatbot-form');
        var chatbotInput = document.getElementById('chatbot-input');
        var chatbotMessages = document.getElementById('chatbot-messages');
        var recSection = document.getElementById('cinema-recommendations-section');
        var recList = document.getElementById('cinema-recommendations');
        var recLoading = document.getElementById('cinema-recommendations-loading');
        var chatHistory = [];
        if (chatbotForm && chatbotInput && chatbotMessages) {
            chatbotForm.addEventListener('submit', async function (e) {
                e.preventDefault();
                var userMsg = chatbotInput.value.trim();
                if (!userMsg) return;
                // Affiche le message utilisateur
                var userDiv = document.createElement('div');
                userDiv.style.alignSelf = 'flex-end';
                userDiv.style.background = '#ffecd2';
                userDiv.style.borderRadius = '12px';
                userDiv.style.padding = '0.7rem 1rem';
                userDiv.style.margin = '0.2rem 0';
                userDiv.style.maxWidth = '85%';
                userDiv.textContent = userMsg;
                chatbotMessages.appendChild(userDiv);
                chatbotInput.value = '';
                chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
                // Ajoute au chatHistory
                chatHistory.push({ role: 'user', content: userMsg });
                // Affiche le spinner de chargement
                if (recLoading) recLoading.style.display = 'flex';
                // Appel API
                var response = await fetch('/cinema_chatbot_api', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ history: chatHistory })
                });
                var data = await response.json();
                console.log('R√©ponse backend:', data);
                // Masque le spinner de chargement
                if (recLoading) recLoading.style.display = 'none';
                // Affiche la r√©ponse du bot
                console.log('SCRIPT INLINE TEMPLATE - MESSAGE BOT:', data.message);
                var botDiv = document.createElement('div');
                botDiv.style.alignSelf = 'flex-start';
                var message = data.message;
                var trimmed = message && message.trim();
                if (trimmed && ((trimmed.startsWith('{') && trimmed.endsWith('}')) || /\{[\s\S]*?\}/.test(trimmed))) {
                  // Ne rien afficher du tout
                } else {
                  botDiv.textContent = message;
                  botDiv.style.borderRadius = '12px';
                  botDiv.style.padding = '0.7rem 1rem';
                  botDiv.style.margin = '0.2rem 0';
                  botDiv.style.maxWidth = '85%';
                  chatbotMessages.appendChild(botDiv);
                }
                chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
                // Ajoute au chatHistory
                chatHistory.push({ role: 'model', content: data.message });
                // Si recommandations pr√©sentes et done=true, redirige vers la page de r√©sultats
                if (data.recommendations && data.recommendations.length && data.done) {
                    console.log('Redirection vers la page de r√©sultats');
                    // window.location.href = '/cinema_recommendations_result/';
                }
            });
        }
    });
</script>
<style>
    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }
    @keyframes fadeInUp {
  from { opacity: 0; transform: translateY(40px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>
{% endblock %}